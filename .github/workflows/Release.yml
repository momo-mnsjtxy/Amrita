name: Manual Build & Release

# 手动触发配置
on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: '发布版本号 (例如: v1.0.0)'
        required: true
        type: string
      releaseTitle:
        description: 'Release标题'
        required: true
        default: 'New Release'
      releaseNotes:
        description: '发布说明'
        required: false
        default: '功能更新与问题修复'
      isPreRelease:
        description: '是否为预发布版本'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史用于版本标签

      - name: 安装uv
        uses: astral-sh/setup-uv@v5  # 与CI保持一致的包管理工具

      - name: 设置Python环境
        run: uv python install  # 使用项目指定的Python版本

      - name: 配置环境与依赖
        run: |
          uv venv
          uv sync  # 同步依赖，与CI流程一致

      - name: 获取Python路径
        run: |
          PYTHON_BIN="$(uv run python -c 'import sys; print(sys.executable)')"
          echo "PYTHON_BIN=$PYTHON_BIN" >> $GITHUB_ENV

      - name: 类型检查（Pyright）
        uses: jakebailey/pyright-action@v2
        with:
          python-path: ${{ env.PYTHON_BIN }}
          pylance-version: latest-release  # 与CI保持一致的检查配置

      - name: 数据库初始化
        run: |
          source ./.venv/bin/activate
          echo "DATABASE_URL=aiosqlite+:///db.sqlite3" > .env
          uv run amrita orm upgrade  # 与CI相同的数据库准备步骤

      - name: 运行负载测试
        run: |
          echo "ADMIN_GROUP=1" >> .env
          echo "LOG_LEVEL=DEBUG" >> .env
          source ./.venv/bin/activate
          uv run amrita test  # 复用CI中的测试命令

      - name: 代码格式检查（Ruff）
        uses: astral-sh/ruff-action@v3
        with:
          args: check . --exit-non-zero-on-fix  # 与CI保持一致的格式检查

      - name: 构建项目包
        run: uv build  # 使用uv构建，生成dist目录下的whl和tar.gz包

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/  # 保存构建好的包文件

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.releaseVersion }}
          name: ${{ github.event.inputs.releaseTitle }}
          body: ${{ github.event.inputs.releaseNotes }}
          draft: false
          prerelease: ${{ github.event.inputs.isPreRelease }}
          files: |
            dist/*.tar.gz
            dist/*.whl  # 上传uv build生成的标准Python包
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
